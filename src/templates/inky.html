<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ config.name }}</title>
</head>
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/style.css">
<script src="{{ url_for('static', filename='scripts/theme.js') }}"></script>
<script src="{{ url_for('static', filename='scripts/icons_loader.js') }}"></script>
<body>
    <!-- Subtle frame container -->
    <div class="frame">
        <!-- Page Title -->
        <header class="header">
            <h1>{{ config.name }}</h1>
            <button id="themeToggle" class="header-button icon" type="button" style="float:right;" title="Toggle theme">
                <svg class="theme-icon sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="5" stroke="currentColor"></circle>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor"></path>
                </svg>
                <svg class="theme-icon moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor"></path>
                </svg>
            </button>
            {% from 'macros/icons.html' import icon %}
            <a href="{{ url_for('history.history_page') }}" class="settings-button" title="History">{{ icon('clock-counter-clockwise', 'icon-image') | safe }}</a>
            <a href="{{ url_for('playlist.playlists') }}" class="settings-button" title="Playlists">{{ icon('squares-four', 'icon-image') | safe }}</a>
            <a href="{{ url_for('settings.settings_page') }}" class="settings-button" title="Settings">{{ icon('gear-six', 'icon-image') | safe }}</a>
        </header>

        <!-- Display the current image (auto-refreshing preview) -->
        {% set fit = (config.get('preview_size_mode') == 'fit') %}
        <div class="image-container {% if not fit %}native{% endif %}">
            <img id="previewImage" src="{{ url_for('main.preview_image') }}" alt="Current Image"
                 {% if not fit %}style="width: {{ config.resolution[0] }}px; height: {{ config.resolution[1] }}px;"{% endif %}>
        </div>

        <!-- Optional metadata about the current plugin/image (e.g., WPOTD) -->
        <div id="imageMeta" class="image-meta" style="display:none; margin-top: 8px;">
            <div id="imageMetaContent"></div>
        </div>

        <!-- Separator -->
        <div class="separator"></div>
        <h2 class="plugins-title">Plugins</h2>
        {% set icon_map = {
            'ai_text': 'text-t',
            'ai_image': 'magic-wand',
            'weather': 'cloud-sun',
            'calendar': 'calendar-blank',
            'clock': 'clock',
            'newspaper': 'newspaper-clipping',
            'apod': 'planet',
            'unsplash': 'images-square',
            'image_url': 'link-simple',
            'image_upload': 'upload-simple',
            'image_folder': 'folder-simple',
            'screenshot': 'monitor',
            'wpotd': 'book-open-text',
            'comic': 'mask-happy'
        } %}
        <div class="button-grid">
            {% for plugin in plugins %}
            <a href="{{ url_for('plugin.plugin_page', plugin_id=plugin.id) }}" class="icon-button" title="{{ plugin.display_name }}">
                {% set ph = icon_map.get(plugin.id, 'image') %}
                <i class="ph ph-{{ ph }} ph-thin icon-image"></i>
            </a>
            {% endfor %}
        </div>
    </div>
<script>
    // Periodically refresh the preview image by cache-busting the URL
    const previewImg = document.getElementById('previewImage');
    async function refreshPreview(){
        const base = '{{ url_for('main.preview_image') }}';
        previewImg.src = base + '?t=' + Date.now();
        try {
            const res = await fetch('{{ url_for('main.refresh_info') }}');
            const info = await res.json();
            const metaDiv = document.getElementById('imageMeta');
            const metaContent = document.getElementById('imageMetaContent');
            if (info && info.plugin_id === 'wpotd' && info.plugin_meta) {
                const m = info.plugin_meta;
                const date = m.date ? new Date(m.date).toISOString().slice(0,10) : '';
                const caption = m.caption || '';
                const link = m.description_url || m.page_url || '';
                let html = '';
                if (date) html += `<div><strong>Wikipedia Picture of the Day:</strong> ${date}</div>`;
                if (caption) html += `<div style="margin-top:4px;">${caption}</div>`;
                if (link) html += `<div style="margin-top:4px;"><a href="${link}" target="_blank" rel="noopener noreferrer">Learn more</a></div>`;
                if (html) {
                    metaContent.innerHTML = html;
                    metaDiv.style.display = 'block';
                } else {
                    metaDiv.style.display = 'none';
                    metaContent.textContent = '';
                }
            } else {
                metaDiv.style.display = 'none';
                metaContent.textContent = '';
            }
        } catch (e) {
            // Non-fatal if refresh-info endpoint fails
        }
    }
    // Refresh every 5 seconds
    setInterval(refreshPreview, 5000);

    // Click to toggle between fit and native resolution
    (function(){
        const container = previewImg && previewImg.parentElement;
        if (!previewImg || !container) return;
        const nativeWidth = {{ config.resolution[0] }};
        const nativeHeight = {{ config.resolution[1] }};
        previewImg.addEventListener('click', function(){
            if (container.classList.contains('native')) {
                container.classList.remove('native');
                previewImg.removeAttribute('style');
            } else {
                container.classList.add('native');
                previewImg.style.width = nativeWidth + 'px';
                previewImg.style.height = nativeHeight + 'px';
            }
        });
    })();
</script>
<body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ config.name }}</title>
</head>
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
<script src="{{ url_for('static', filename='scripts/theme.js') }}"></script>
<body>
    <!-- Skip navigation for accessibility -->
    <a href="#main-content" class="skip-nav">Skip to main content</a>

    <!-- Subtle frame container -->
    <div class="frame">
        <!-- Page Title -->
        <header class="header">
            <h1>{{ config.name }}</h1>
            <div class="header-icons">
                <div class="nav-icons">
                    {% from 'macros/icons.html' import icon %}
                    <a href="{{ url_for('history.history_page') }}" class="settings-button" title="History">{{ icon('clock-counter-clockwise', 'icon-image') | safe }}</a>
                    <a href="{{ url_for('playlist.playlists') }}" class="settings-button" title="Playlists">{{ icon('squares-four', 'icon-image') | safe }}</a>
                    <a href="{{ url_for('settings.settings_page') }}" class="settings-button" title="Settings">{{ icon('gear-six', 'icon-image') | safe }}</a>
                </div>
                <button id="themeToggle" class="header-button icon" type="button" title="Toggle theme">
                    <svg class="theme-icon sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="12" cy="12" r="5" stroke="currentColor"></circle>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor"></path>
                    </svg>
                    <svg class="theme-icon moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main content area -->
        <main id="main-content" role="main">
            <!-- Display the current image (auto-refreshing preview) -->
            {% set fit = (config.get('preview_size_mode') == 'fit') %}
            <div class="image-container {% if not fit %}native{% endif %}">
                <div id="previewSkeleton" class="img-skeleton" aria-hidden="true"></div>
                <img id="previewImage" src="{{ url_for('main.preview_image') }}" alt="Current display image for {{ config.name }}"
                     width="{{ config.resolution[0] }}" height="{{ config.resolution[1] }}"
                     {% if not fit %}style="width: {{ config.resolution[0] }}px; height: {{ config.resolution[1] }}px;"{% endif %}>
            </div>

        <!-- Optional metadata about the current plugin/image (e.g., WPOTD) -->
        <div id="imageMeta" class="image-meta" style="display:none; margin-top: 8px;">
            <div id="imageMetaContent"></div>
        </div>

        <!-- Now showing: current plugin/instance/playlist -->
        <div id="nowShowing" class="image-meta" style="margin-top: 8px; {% if not refresh_info.plugin_id %}display:none;{% endif %}">
            <div id="nowShowingContent">
                <strong>Now showing:</strong>
                <span id="nsPlugin">{{ refresh_info.plugin_id or '' }}</span>
                {% if refresh_info.plugin_instance %}
                (<span id="nsInstance">{{ refresh_info.plugin_instance }}</span>)
                {% else %}
                <span id="nsInstance" style="display:none;"></span>
                {% endif %}
                {% if refresh_info.playlist %}
                • <span id="nsPlaylist">{{ refresh_info.playlist }}</span>
                {% else %}
                <span id="nsPlaylist" style="display:none;"></span>
                {% endif %}
            </div>
        </div>

        <!-- Next up: non-mutating preview of the upcoming instance -->
        <div id="nextUp" class="image-meta" style="margin-top: 4px; {% if not next_up or not next_up.plugin_id %}display:none;{% endif %}">
            <div id="nextUpContent">
                <strong>Next up:</strong>
                <span id="nuPlugin">{{ next_up.plugin_id if next_up else '' }}</span>
                {% if next_up and next_up.plugin_instance %}
                (<span id="nuInstance">{{ next_up.plugin_instance }}</span>)
                {% else %}
                <span id="nuInstance" style="display:none;"></span>
                {% endif %}
                {% if next_up and next_up.playlist %}
                • <span id="nuPlaylist">{{ next_up.playlist }}</span>
                {% else %}
                <span id="nuPlaylist" style="display:none;"></span>
                {% endif %}
                <button id="displayNextBtn" class="action-button compact" style="margin-left:8px;" onclick="displayNextNow()">Display Next</button>
            </div>
        </div>

        </main>

        <!-- Separator -->
        <div class="separator" role="separator"></div>

        <!-- Plugin navigation section -->
        <section aria-label="Available plugins">
            <h2 class="plugins-title">Plugins</h2>
        {% set icon_map = {
            'ai_text': 'text-t',
            'ai_image': 'magic-wand',
            'weather': 'cloud-sun',
            'calendar': 'calendar-blank',
            'clock': 'clock',
            'newspaper': 'newspaper-clipping',
            'apod': 'planet',
            'unsplash': 'images-square',
            'image_url': 'link-simple',
            'image_upload': 'upload-simple',
            'image_folder': 'folder-simple',
            'screenshot': 'monitor',
            'wpotd': 'book-open-text',
            'comic': 'mask-happy'
        } %}
            <div class="button-grid">
                {% for plugin in plugins %}
                <a href="{{ url_for('plugin.plugin_page', plugin_id=plugin.id) }}" class="icon-button"
                   title="{{ plugin.display_name }}"
                   aria-label="Open {{ plugin.display_name }} plugin settings">
                    {% set ph = icon_map.get(plugin.id, 'image') %}
                    {% from 'macros/icons.html' import icon %}
                    {{ icon(ph, 'icon-image') | safe }}
                    <span class="sr-only">{{ plugin.display_name }}</span>
                </a>
                {% endfor %}
            </div>
        </section>
    </div>
<script>
    // Periodically refresh the preview image by cache-busting the URL
    const previewImg = document.getElementById('previewImage');
    const previewSkel = document.getElementById('previewSkeleton');
    if (previewImg) {
        previewImg.addEventListener('load', function(){ if (previewSkel) previewSkel.style.display = 'none'; });
        previewImg.addEventListener('error', function(){ if (previewSkel) previewSkel.style.display = 'none'; });
    }
    // Track latest image hash so we can avoid reloading when unchanged
    let lastImageHash = {{ refresh_info.get('image_hash')|tojson }};

    async function refreshPreview(){
        const base = '{{ url_for('main.preview_image') }}';
        let info = null;
        let up = null;
        // Fetch refresh_info and next_up concurrently
        try {
            [info, up] = await Promise.all([
                fetch('{{ url_for('main.refresh_info') }}').then(r => r.json()).catch(() => null),
                fetch('{{ url_for('main.next_up') }}').then(r => r.json()).catch(() => null)
            ]);
        } catch(e) {
            info = null;
            up = null;
        }

        if (info) {
            // Only reload image if the hash changed
            if (info.image_hash && info.image_hash !== lastImageHash) {
                lastImageHash = info.image_hash;
                if (previewSkel) previewSkel.style.display = '';
                previewImg.src = base + '?t=' + Date.now();
            }

            const metaDiv = document.getElementById('imageMeta');
            const metaContent = document.getElementById('imageMetaContent');
            if (info.plugin_id === 'wpotd' && info.plugin_meta) {
                const m = info.plugin_meta;
                const date = m.date ? new Date(m.date).toISOString().slice(0,10) : '';
                const caption = m.caption || '';
                const link = m.description_url || m.page_url || '';
                let html = '';
                if (date) html += `<div><strong>Wikipedia Picture of the Day:</strong> ${date}</div>`;
                if (caption) html += `<div style="margin-top:4px;">${caption}</div>`;
                if (link) html += `<div style=\"margin-top:4px;\"><a href=\"${link}\" target=\"_blank\" rel=\"noopener noreferrer\">Learn more</a></div>`;
                if (html) {
                    metaContent.innerHTML = html;
                    metaDiv.style.display = 'block';
                } else {
                    metaDiv.style.display = 'none';
                    metaContent.textContent = '';
                }
            } else {
                metaDiv.style.display = 'none';
                metaContent.textContent = '';
            }

            // Update Now showing block
            const ns = document.getElementById('nowShowing');
            const nsPlugin = document.getElementById('nsPlugin');
            const nsInst = document.getElementById('nsInstance');
            const nsPl = document.getElementById('nsPlaylist');
            if (ns && nsPlugin && nsInst && nsPl) {
                if (info.plugin_id) {
                    ns.style.display = 'block';
                    nsPlugin.textContent = info.plugin_id || '';
                    if (info.plugin_instance) {
                        nsInst.style.display = '';
                        nsInst.textContent = info.plugin_instance;
                    } else {
                        nsInst.style.display = 'none';
                        nsInst.textContent = '';
                    }
                    if (info.playlist) {
                        nsPl.style.display = '';
                        nsPl.textContent = info.playlist;
                    } else {
                        nsPl.style.display = 'none';
                        nsPl.textContent = '';
                    }
                } else {
                    ns.style.display = 'none';
                }
            }
        }

        if (up) {
            // Update Next up block
            const nu = document.getElementById('nextUp');
            const nuPlugin = document.getElementById('nuPlugin');
            const nuInst = document.getElementById('nuInstance');
            const nuPl = document.getElementById('nuPlaylist');
            if (nu && nuPlugin && nuInst && nuPl) {
                if (up.plugin_id) {
                    nu.style.display = 'block';
                    nuPlugin.textContent = up.plugin_id || '';
                    if (up.plugin_instance) {
                        nuInst.style.display = '';
                        nuInst.textContent = up.plugin_instance;
                    } else {
                        nuInst.style.display = 'none';
                        nuInst.textContent = '';
                    }
                    if (up.playlist) {
                        nuPl.style.display = '';
                        nuPl.textContent = up.playlist;
                    } else {
                        nuPl.style.display = 'none';
                        nuPl.textContent = '';
                    }
                } else {
                    nu.style.display = 'none';
                }
            }
        }
    }

    async function displayNextNow(){
        const btn = document.getElementById('displayNextBtn');
        if (btn) btn.disabled = true;
        try{
            const resp = await fetch('{{ url_for('main.display_next') }}', {method:'POST'});
            const j = await resp.json();
            if (!resp.ok || !j.success){
                showResponseModal('failure', 'Failed to display next: ' + (j.error || 'Unknown error'));
            } else {
                // Refresh preview and info shortly after
                setTimeout(refreshPreview, 300);
            }
        } catch(e){ /* ignore */ }
        finally { if (btn) btn.disabled = false; }
    }
    // Refresh every 5 seconds; optionally use SSE/WebSocket when available
    function startPolling(){
        refreshPreview();
        return setInterval(refreshPreview, 5000);
    }
    (function(){
        const pushUrl = window.INKYPI_PUSH_URL;
        if (pushUrl && window.EventSource){
            try {
                const es = new EventSource(pushUrl);
                es.onmessage = () => refreshPreview();
                es.onerror = () => { es.close(); startPolling(); };
            } catch(e){
                startPolling();
            }
        } else {
            startPolling();
        }
    })();

    // Click to toggle between fit and native resolution
    (function(){
        const container = previewImg && previewImg.parentElement;
        if (!previewImg || !container) return;
        const nativeWidth = {{ config.resolution[0] }};
        const nativeHeight = {{ config.resolution[1] }};
        previewImg.addEventListener('click', function(){
            if (container.classList.contains('native')) {
                container.classList.remove('native');
                previewImg.removeAttribute('style');
            } else {
                container.classList.add('native');
                previewImg.style.width = nativeWidth + 'px';
                previewImg.style.height = nativeHeight + 'px';
            }
        });
    })();
</script>
</body>
</html>

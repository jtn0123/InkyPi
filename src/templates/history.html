<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History</title>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
    <script src="{{ url_for('static', filename='scripts/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/lightbox.js') }}"></script>
    <script>
        async function redisplay(filename) {
            const btn = document.getElementById('btn-' + filename);
            if (btn) btn.disabled = true;
            try {
                const resp = await fetch("{{ url_for('history.history_redisplay') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const result = await resp.json();
                if (!resp.ok) {
                    showResponseModal('failure', `Error!  ${result.error}`);
                } else {
                    showResponseModal('success', `Success! ${result.message}`);
                }
            } catch (e) {
                console.error(e);
                showResponseModal('failure', 'Failed to redisplay image. Please try again.');
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        async function deleteImage(filename) {
            openDeleteHistoryModal(filename);
        }

        async function clearHistory() { openClearAllHistoryModal(); }

        // Delete modals for History page
        function openDeleteHistoryModal(filename){
            const text = document.getElementById('deleteHistoryText');
            text.textContent = `Delete this image '${filename}'?`;
            document.getElementById('deleteHistoryModal').style.display = 'block';
            const btn = document.getElementById('confirmDeleteHistoryBtn');
            btn.onclick = async function(){
                try {
                    const resp = await fetch("{{ url_for('history.history_delete') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename }) });
                    const result = await resp.json();
                    if (!resp.ok) {
                        showResponseModal('failure', `Error!  ${result.error}`);
                    } else {
                        sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                        location.reload();
                    }
                } catch (e) { console.error(e); showResponseModal('failure', 'Failed to delete image'); }
                closeDeleteHistoryModal();
            }
        }
        function closeDeleteHistoryModal(){ document.getElementById('deleteHistoryModal').style.display = 'none'; }

        function openClearAllHistoryModal(){
            document.getElementById('clearHistoryModal').style.display = 'block';
            const btn = document.getElementById('confirmClearHistoryBtn');
            btn.onclick = async function(){
                try {
                    const resp = await fetch("{{ url_for('history.history_clear') }}", { method: 'POST' });
                    const result = await resp.json();
                    if (!resp.ok) {
                        showResponseModal('failure', `Error!  ${result.error}`);
                    } else {
                        sessionStorage.setItem("storedMessage", JSON.stringify({ type: "success", text: `Success! ${result.message}` }));
                        location.reload();
                    }
                } catch (e) { console.error(e); showResponseModal('failure', 'Failed to clear history'); }
                closeClearHistoryModal();
            }
        }
        function closeClearHistoryModal(){ document.getElementById('clearHistoryModal').style.display = 'none'; }
    </script>
</head>
<body>
    <main>
    <div class="frame">
        {% from 'macros/icons.html' import icon %}
        <div class="app-header">
            <div class="header-content">
                <div style="display:flex;align-items:center;gap:10px;">
                    <a href="{{ url_for('main.main_page') }}" class="header-button icon" title="Home" aria-label="Home">{{ icon('house', 'icon-image') | safe }}</a>
                    <button id="themeToggle" class="header-button icon" type="button" title="Toggle theme" aria-label="Toggle theme">
                        <svg class="theme-icon sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="5" stroke="currentColor"></circle>
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor"></path>
                        </svg>
                        <svg class="theme-icon moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor"></path>
                        </svg>
                    </button>
                    <div class="title-container">
                        {{ icon('clock-counter-clockwise', 'app-icon') | safe }}
                        <h1 class="app-title">History</h1>
                    </div>
                </div>
                <div style="margin-left:auto;display:flex;align-items:center;gap:12px;">
                    <button class="header-button" onclick="location.reload()">Refresh</button>
                    <button class="header-button" style="background-color: #c4515b;" onclick="clearHistory()">Clear All</button>
                </div>
            </div>
        </div>
        <div class="separator"></div>
        {% if metrics %}
        <div style="padding:8px 16px; font-size: 13px; color: var(--text);">
            <strong>Last Request:</strong>
            <span>Request {{ metrics.request_ms or '-' }} ms</span>
            <span>• Generate {{ metrics.generate_ms or '-' }} ms</span>
            <span>• Preprocess {{ metrics.preprocess_ms or '-' }} ms</span>
            <span>• Display {{ metrics.display_ms or '-' }} ms</span>
        </div>
        <div class="separator"></div>
        {% endif %}
        <div id="storage-block" style="padding: 12px 16px; {% if not storage or storage.pct_free is none %}display:none;{% endif %}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:14px;color:var(--text);font-weight:600;">Storage available</div>
                <div id="storage-text" style="font-size:13px;color:var(--muted);">
                    {% if storage and storage.pct_free is not none %}
                        {{ storage.pct_free|round(2) }}% free • {{ storage.free_gb }} GB remaining of {{ storage.total_gb }} GB total
                    {% else %}
                        --
                    {% endif %}
                </div>
            </div>
            <div style="background:#e6e6e6;border-radius:8px;height:14px;overflow:hidden;">
                <div id="storage-bar-inner" style="background:linear-gradient(90deg,#5bd07a,#3aa35a);height:100%;width:{% if storage and storage.pct_free is not none %}{{ storage.pct_free }}%{% else %}0%{% endif %}"></div>
            </div>
        </div>

        <script>
            async function updateStorage() {
                try {
                    const resp = await fetch("{{ url_for('history.history_storage') }}");
                    const data = await resp.json();
                    if (!resp.ok) return;
                    const block = document.getElementById('storage-block');
                    const text = document.getElementById('storage-text');
                    const inner = document.getElementById('storage-bar-inner');
                    block.style.display = '';
                    const pct = (data.pct_free !== null && data.pct_free !== undefined) ? data.pct_free : 0;
                    text.textContent = `${pct}% free • ${data.free_gb} GB remaining of ${data.total_gb} GB total`;
                    inner.style.width = `${pct}%`;
                } catch (e) {
                    console.error('Failed to update storage', e);
                }
            }

            // Update storage on initial load
            document.addEventListener('DOMContentLoaded', function() {
                updateStorage();
                // If we have a stored message (from a delete/clear action), show it
                const stored = sessionStorage.getItem('storedMessage');
                if (stored) {
                    try {
                        const m = JSON.parse(stored);
                        if (m && m.type && m.text) showResponseModal(m.type, m.text);
                    } catch (e) {}
                    sessionStorage.removeItem('storedMessage');
                }
            });

            // Expose function for other actions to refresh storage after operations
            window.updateHistoryStorage = updateStorage;


        </script>

        {% if images|length == 0 %}
            <p>No history yet.</p>
        {% else %}
        <div class="history-grid">
            {% for img in images %}
            <div class="history-card">
                <a class="history-thumb" href="{{ url_for('history.history_image', filename=img.filename) }}" aria-label="Preview {{ img.filename }}">
                    <div class="img-skeleton" aria-hidden="true"></div>
                    <img src="{{ url_for('history.history_image', filename=img.filename) }}" alt="{{ img.filename }}" loading="lazy" onload="this.previousElementSibling.style.display='none'" onerror="this.previousElementSibling.style.display='none'">
                </a>
                <div class="history-meta">
                    <div class="history-name" title="{{ img.filename }}">{{ img.filename }}</div>
                    <div class="history-sub">{{ img.mtime_str }} • {{ img.size_str }}</div>
                    {% if img.meta and (img.meta.refresh_type or img.meta.plugin_id) %}
                    <div class="history-sub">
                        <span>Source:</span>
                        <span>
                            {% if img.meta.refresh_type %}{{ img.meta.refresh_type }}{% endif %}
                            {% if img.meta.plugin_id %} • {{ img.meta.plugin_id }}{% endif %}
                            {% if img.meta.playlist %} • {{ img.meta.playlist }}{% endif %}
                            {% if img.meta.plugin_instance %} • {{ img.meta.plugin_instance }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
                <div class="history-actions">
                    <button id="btn-{{ img.filename }}" class="btn btn-primary" onclick="redisplay('{{ img.filename }}')">Display</button>
                    <a class="btn" href="{{ url_for('history.history_image', filename=img.filename) }}" download>Download</a>
                    <button class="btn btn-danger" onclick="deleteImage('{{ img.filename }}')">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Image preview (lightbox) for history thumbnails -->
    <div id="imagePreviewModal" class="modal image-modal" role="dialog" aria-modal="true" aria-labelledby="imagePreviewTitle" style="display:none;">
        <div class="modal-content">
            <span class="close-button" onclick="Lightbox.close()" aria-label="Close">×</span>
            <img id="imagePreviewImg" alt="Large preview" style="max-width:92vw; max-height:85vh; display:block; margin:0 auto;"/>
        </div>
    </div>

    <script>
        // Bind history thumbnails to shared Lightbox
        document.addEventListener('click', function(ev){
            const a = ev.target.closest('a.history-thumb');
            if (!a) return;
            if (ev.metaKey || ev.ctrlKey || ev.shiftKey || ev.altKey) return;
            ev.preventDefault();
            const img = a.querySelector('img');
            const url = a.href;
            const alt = a.getAttribute('aria-label') || (img && img.alt) || 'Preview';
            if (window.Lightbox) window.Lightbox.open(url, alt);
        });
    </script>

    <!-- Delete image modal -->
    <div id="deleteHistoryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteHistoryTitle" style="display:none;">
        <div class="modal-content">
            <span class="close-button" onclick="closeDeleteHistoryModal()" aria-label="Close">×</span>
            <h2 id="deleteHistoryTitle">Delete Image</h2>
            <div class="separator"></div>
            <p id="deleteHistoryText">Are you sure you want to delete?</p>
            <div class="buttons-container" style="margin-top:12px;">
                <button type="button" class="action-button warn" id="confirmDeleteHistoryBtn">Delete</button>
                <button type="button" class="action-button" onclick="closeDeleteHistoryModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Clear all history modal -->
    <div id="clearHistoryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="clearHistoryTitle" style="display:none;">
        <div class="modal-content">
            <span class="close-button" onclick="closeClearHistoryModal()" aria-label="Close">×</span>
            <h2 id="clearHistoryTitle">Clear All History</h2>
            <div class="separator"></div>
            <p>Are you sure you want to clear all history images?</p>
            <div class="buttons-container" style="margin-top:12px;">
                <button type="button" class="action-button warn" id="confirmClearHistoryBtn">Clear</button>
                <button type="button" class="action-button" onclick="closeClearHistoryModal()">Cancel</button>
            </div>
        </div>
    </div>

    {% include 'response_modal.html' %}
    </main>
</body>
</html>



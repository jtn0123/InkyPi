<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ plugin.display_name }} Settings</title>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
    <script src="{{ url_for('static', filename='scripts/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>
    

    <script>
        const pluginSettings = {{ plugin_settings | tojson if plugin_settings else {} }};
        const pluginInstanceName ='{{ plugin_instance }}';
        const hasPluginSettings = !!(pluginSettings && Object.keys(pluginSettings).length);
        // Treat either editing an instance or having saved (non-instance) settings as "load settings"
        const loadPluginSettings = (pluginInstanceName != '') || hasPluginSettings;
        const styleSettings = {{ style_settings | default(false) | tojson }};
        const previewUrl = '{{ url_for("main.preview_image") }}';
        const refreshInfoUrl = '{{ url_for("main.refresh_info") }}';
        const instancePreviewUrl = (pluginId, instanceName) => {
            if (!pluginId || !instanceName) return null;
            return '{{ url_for("plugin.plugin_instance_image", plugin_id="__PID__", instance_name="__INST__") }}'
                .replace('__PID__', encodeURIComponent(pluginId))
                .replace('__INST__', encodeURIComponent(instanceName));
        };
        const latestPluginUrl = (pluginId) => {
            if (!pluginId) return null;
            return '{{ url_for("plugin.plugin_latest_image", plugin_id="__PID__") }}'
                .replace('__PID__', encodeURIComponent(pluginId));
        };

        let uploadedFiles = {};

        const PROGRESS_PAGE_CTX = { page: 'plugin', pluginId: {{ plugin.id|tojson }}, instance: pluginInstanceName || null };
        function buildProgressKey(ctx){
            try {
                if (ctx && ctx.page === 'plugin'){
                    const pid = ctx.pluginId || {{ plugin.id|tojson }};
                    const inst = ctx.instance || '';
                    return `INKYPI_LAST_PROGRESS:plugin:${pid}:${inst || '_'}`;
                }
            } catch(e){}
            return 'INKYPI_LAST_PROGRESS';
        }
        function saveLastProgressSnapshot(context){
            try {
                const list = document.getElementById('requestProgressList');
                const textEl = document.getElementById('requestProgressText');
                function extractLine(li){
                    try {
                        const t = li.querySelector('time');
                        const txt = li.textContent || '';
                        const tt = t ? (t.textContent || '') : '';
                        return tt && txt.startsWith(tt) ? txt.slice(tt.length).trimStart() : txt.trim();
                    } catch(e){ return (li.textContent || '').trim(); }
                }
                const lines = Array.from(list ? list.querySelectorAll('li') : [], extractLine);
                const data = {
                    finishedAtIso: new Date().toISOString(),
                    summary: textEl ? textEl.textContent : 'Done',
                    lines,
                    ctx: context || PROGRESS_PAGE_CTX
                };
                const key = buildProgressKey(data.ctx);
                localStorage.setItem(key, JSON.stringify(data));
                // Also store a global fallback
                localStorage.setItem('INKYPI_LAST_PROGRESS', JSON.stringify(data));
            } catch(e){}
        }
        function showLastProgress(){
            try {
                const keys = [
                    buildProgressKey(PROGRESS_PAGE_CTX),
                    `INKYPI_LAST_PROGRESS:plugin:${ {{ plugin.id|tojson }} }:_`,
                    'INKYPI_LAST_PROGRESS'
                ];
                let data = null;
                for (const k of keys){
                    const raw = localStorage.getItem(k);
                    if (raw){ data = JSON.parse(raw); break; }
                }
                if (!data) { try { showResponseModal('failure', 'No recent progress to show'); } catch(_){} return; }
                const progress = document.getElementById('requestProgress');
                const textEl = document.getElementById('requestProgressText');
                const clockEl = document.getElementById('requestProgressClock');
                const elapsedEl = document.getElementById('requestProgressElapsed');
                const list = document.getElementById('requestProgressList');
                const bar = document.getElementById('requestProgressBar');
                if (list) {
                    list.innerHTML = '';
                    const stripLeadingTime = (s) => {
                        try { return s.replace(/^\s*\d{1,2}:\d{2}(?::\d{2})?\s*(AM|PM)?\s*/i, ''); } catch(_) { return s; }
                    };
                    data.lines.forEach(rawLine => {
                        const line = stripLeadingTime(rawLine);
                        const li = document.createElement('li');
                        const ts = document.createElement('time');
                        ts.textContent = new Date(data.finishedAtIso).toLocaleTimeString();
                        li.appendChild(ts);
                        li.appendChild(document.createTextNode(' ' + line));
                        list.appendChild(li);
                    });
                }
                if (textEl) textEl.textContent = data.summary || 'Last run';
                if (clockEl) clockEl.textContent = new Date(data.finishedAtIso).toLocaleTimeString();
                if (elapsedEl) elapsedEl.textContent = '—';
                if (bar) bar.style.width = '100%';
                if (progress) progress.style.display = 'block';
            } catch(e){}
        }

        async function handleAction(action) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const progress = document.getElementById('requestProgress');
            const progressText = document.getElementById('requestProgressText');
            const progressClock = document.getElementById('requestProgressClock');
            const progressElapsed = document.getElementById('requestProgressElapsed');
            const progressList = document.getElementById('requestProgressList');
            const bar = document.getElementById('requestProgressBar');
            const t0 = Date.now();
            let clockTimer = null;
            function fmtElapsed(ms){
                const s = Math.floor(ms / 1000);
                const m = Math.floor(s / 60);
                const rem = s % 60;
                if (m > 0) return `${m}m ${rem}s`;
                return `${s}s`;
            }
            function tickClock(){
                try {
                    if (progressClock) progressClock.textContent = new Date().toLocaleTimeString();
                    if (progressElapsed) progressElapsed.textContent = fmtElapsed(Date.now() - t0);
                } catch(e){}
            }
            function ensureVisible(){ if (progress) progress.style.display = 'block'; }
            function addLog(line){
                if (!progressList) return;
                const li = document.createElement('li');
                const ts = document.createElement('time');
                ts.dateTime = new Date().toISOString();
                ts.textContent = new Date().toLocaleTimeString();
                li.appendChild(ts);
                li.appendChild(document.createTextNode(line));
                progressList.appendChild(li);
                try { progressList.scrollTop = progressList.scrollHeight; } catch(e){}
            }
            function setStep(text, pct){
                ensureVisible();
                if (progressText) progressText.textContent = text;
                if (bar && typeof pct === 'number') bar.style.width = pct + '%';
                addLog(text);
            }
            loadingIndicator.style.display = 'block';
            // Reset meta & log
            try { if (clockTimer) clearInterval(clockTimer); } catch(e){}
            try {
                if (progressList) progressList.innerHTML = '';
                if (progressElapsed) progressElapsed.textContent = '0s';
                if (progressClock) progressClock.textContent = new Date().toLocaleTimeString();
                if (bar) bar.style.width = '10%';
            } catch(e){}
            tickClock();
            clockTimer = setInterval(tickClock, 1000);
            setStep('Preparing…', 10);

            // Allow plugin-specific client-side validation (e.g., require lat/long for Weather)
            try {
                if (typeof window.validatePluginSettings === 'function') {
                    const isValid = window.validatePluginSettings(action);
                    if (!isValid) {
                        loadingIndicator.style.display = 'none';
                        if (progress) progress.style.display = 'none';
                        return; // abort submission
                    }
                }
            } catch (e) {
                console.warn('Plugin validation threw an error:', e);
            }

            // Gather plugin settings form data
            const form = document.getElementById('settingsForm');
            const scheduleForm = document.getElementById('scheduleForm');

            const formData = new FormData(form);
            let url = '{{ url_for("plugin.update_now") }}';
            let method = 'POST';
            let clearFormOnSubmit = true;
            
            // Add uploaded files to the form under its key
            Object.keys(uploadedFiles).forEach(key => {
                if (uploadedFiles[key].length > 0) {
                    uploadedFiles[key].forEach(file => {
                        formData.append(key, file);
                    });
                }
            });

            if (action == "add_to_playlist"){
                url = '{{ url_for('playlist.add_plugin') }}';
                const scheduleFormData = new FormData(scheduleForm);
                const scheduleData = {};
                for (const [key, value] of scheduleFormData.entries()) {
                    scheduleData[key] = value;
                }
                formData.append("refresh_settings", JSON.stringify(scheduleData));
            } else if (action == "update_instance") {
                url = "{{ url_for('plugin.update_plugin_instance', instance_name='') }}" + pluginInstanceName,
                method = 'PUT'
                clearFormOnSubmit = false
            } else if (action == "save_settings") {
                url = '{{ url_for("plugin.save_plugin_settings") }}';
                clearFormOnSubmit = false
            }

            // Send data to the server
            try {
                setStep('Sending…', 30);
                const response = await fetch(url, {method: method, body: formData});
                setStep('Waiting (device)…', 60);
                const result = await response.json();
                // Handle the response
                if (response.ok) {
                    // Show metrics if present
                    if (result && result.metrics) {
                        const m = result.metrics || {};
                        if (Array.isArray(m.steps) && m.steps.length) {
                            let pct = 60;
                            const inc = 30 / m.steps.length;
                            for (const [name, ms] of m.steps) {
                                pct += inc;
                                setStep(`${name} ${ms} ms`, pct);
                                await new Promise(r => setTimeout(r, 50));
                            }
                        }
                        // Compose clean summary: include only available metrics
                        const parts = [];
                        const add = (label, val) => { if (val !== null && val !== undefined) parts.push(`${label} ${val} ms`); };
                        add('Request', m.request_ms);
                        add('Generate', m.generate_ms);
                        add('Preprocess', m.preprocess_ms);
                        add('Display', m.display_ms);
                        if (parts.length) {
                            const text = parts.join(' • ');
                            if (progressText) progressText.textContent = text;
                            addLog(text);
                        }
                    }
                    setStep('Display updating…', 90);
                    showResponseModal('success', `Success! ${result.message}`);
                    // Trigger preview refresh shortly after success
                    setTimeout(() => { refreshPreviewImage(); }, 250);
                } else {
                    showResponseModal('failure', `Error!  ${result.error}`);
                }
                closeModal('scheduleModal');

                if (clearFormOnSubmit) {
                    form.reset()
                    uploadedFiles = {};
                    document.querySelectorAll('input[clear-on-submit]').forEach(input => {
                        input.value = '';
                        input.dispatchEvent(new Event('change'));
                    });
                    document.querySelectorAll('[delete-on-submit]').forEach(div => {
                        div.remove();
                    });
                    if (action == "add_to_playlist"){
                        scheduleForm.reset()
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            } finally {
                // Hide loading indicator after the action is complete
                loadingIndicator.style.display = 'none';
                setStep('Done', 100);
                try { if (clockTimer) clearInterval(clockTimer); } catch(e){}
                saveLastProgressSnapshot(PROGRESS_PAGE_CTX);
                setTimeout(() => { if (progress) progress.style.display = 'none'; }, 2000);
            }
        }
        async function refreshPreviewImage(){
            const img = document.getElementById('previewImage');
            const skel = document.getElementById('previewSkeleton');
            if (img){ if (skel) skel.style.display=''; img.src = previewUrl + '?t=' + Date.now(); }
            // Update current display timestamp/meta
            try {
                const res = await fetch(refreshInfoUrl);
                const info = await res.json();
                // Update current display timestamp
                const ts = info && info.refresh_time ? new Date(info.refresh_time) : null;
                const currTime = document.getElementById('currentDisplayTime');
                if (currTime) currTime.textContent = ts ? ts.toLocaleString() : '—';
                // Update optional plugin meta (e.g., WPOTD)
                const metaDiv = document.getElementById('pluginMeta');
                const metaContent = document.getElementById('pluginMetaContent');
                if (info && info.plugin_id === 'wpotd' && info.plugin_meta) {
                    const m = info.plugin_meta;
                    const date = m.date ? new Date(m.date).toISOString().slice(0,10) : '';
                    const caption = m.caption || '';
                    const link = m.description_url || m.page_url || '';
                    let html = '';
                    if (date) html += `<div><strong>Wikipedia Picture of the Day:</strong> ${date}</div>`;
                    if (caption) html += `<div style=\"margin-top:4px;\">${caption}</div>`;
                    if (link) html += `<div style=\"margin-top:4px;\"><a href=\"${link}\" target=\"_blank\" rel=\"noopener noreferrer\">Learn more</a></div>`;
                    if (html) {
                        metaContent.innerHTML = html;
                        metaDiv.style.display = 'block';
                    } else {
                        metaDiv.style.display = 'none';
                        metaContent.textContent = '';
                    }
                } else {
                    metaDiv.style.display = 'none';
                    metaContent.textContent = '';
                }
            } catch (e) { /* ignore */ }
        }

        function openModal(modal_id) {
            const modal = document.getElementById(modal_id);
            modal.style.display = 'block';
        }
    
        function closeModal(modal_id) {
            const modal = document.getElementById(modal_id);
            modal.style.display = 'none';
        }
    
        // Close modal if the user clicks outside the modal content
        window.onclick = function (event) {
            const modal = document.getElementById('scheduleModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        function toggleCollapsible(button) {
            const content = button.nextElementSibling;
            const icon = button.querySelector(".collapsible-icon");
            button.classList.toggle("active");
            content.style.display = content.style.display === "block" ? "none" : "block";
            icon.textContent = content.style.display === "block" ? "▲" : "▼";
        }

        function selectedFrame(element) {
            // Remove the selected class from any previously selected option
            const previousSelection = document.querySelector('.image-option.selected');
            if (previousSelection) {
                previousSelection.classList.remove('selected');
            }

            // Add the selected class to the clicked option
            element.classList.add('selected');

            // Update the hidden input with the selected frame
            const selectedFaceName = element.getAttribute('data-face-name');
            document.getElementById('selected-frame').value = selectedFaceName;
        }

        function showFileName() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameDisplay = document.getElementById('fileName');
            const fileNameText = document.getElementById('fileNameText');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');
            const removeFileButton = document.getElementById('removeFileButton');
            const file = fileInput.files[0];

            if (file) {
                fileNameText.textContent = `${file.name}`;
                fileNameDisplay.style.display = 'flex';  // Show the file name and remove button
                uploadButtonLabel.style.display = 'none';  // Hide the upload button label
            } else {
                fileNameDisplay.style.display = 'none';  // Hide if no file is selected
                uploadButtonLabel.style.display = 'block';  // Show the upload button label
            }
        }

        function removeFile() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameDisplay = document.getElementById('fileName');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');

            fileInput.value = '';  // Clear the file input
            fileNameDisplay.style.display = 'none';  // Hide the file name and remove button
            uploadButtonLabel.style.display = 'block';  // Show the upload button label

            const hiddenElement = document.getElementById(`hidden-file-name`);
            if (hiddenElement) {
                hiddenElement.remove();
            }
        }

        // populate form values from plugin settings
        document.addEventListener('DOMContentLoaded', () => {
            // Populate top status bar previews and timestamps
            (function initStatusBar(){
                const pluginId = '{{ plugin.id }}';
                const instanceName = pluginInstanceName;
                const instImgEl = document.getElementById('instancePreviewImage');
                const instTimeEl = document.getElementById('instanceLastTime');
                const instUrl = instancePreviewUrl(pluginId, instanceName);
                const latestUrl = latestPluginUrl(pluginId);
                if (instImgEl) {
                    const url = instUrl || latestUrl;
                    if (url) instImgEl.src = url + '?t=' + Date.now();
                }
                const lastStr = '{{ plugin_instance_last_refresh or plugin_latest_refresh or '' }}';
                if (instTimeEl) {
                    instTimeEl.textContent = lastStr ? new Date(lastStr).toLocaleString() : '—';
                }
                // Also initialize current display timestamp
                refreshPreviewImage();
            })();
            if (!styleSettings){
                return;
            }
            if (loadPluginSettings) {
                if (pluginSettings.topMargin) {
                    document.getElementById('topMargin').value = pluginSettings.topMargin;
                }
                if (pluginSettings.bottomMargin) {
                    document.getElementById('bottomMargin').value = pluginSettings.bottomMargin;
                }
                if (pluginSettings.leftMargin) {
                    document.getElementById('leftMargin').value = pluginSettings.leftMargin;
                }
                if (pluginSettings.rightMargin) {
                    document.getElementById('rightMargin').value = pluginSettings.rightMargin;
                }
                // Populate background options (color or image)
                if (pluginSettings.backgroundOption) {
                    document.querySelector(`input[name="backgroundOption"][value="${pluginSettings.backgroundOption}"]`).checked = true;
                }

                // Set background color
                if (pluginSettings.backgroundColor) {
                    document.getElementById('backgroundColor').value = pluginSettings.backgroundColor;
                }

                // Populate text color
                if (pluginSettings.textColor) {
                    document.getElementById('textColor').value = pluginSettings.textColor;
                }

                // Handle background image selection
                const fileNameDisplay = document.getElementById('fileName');
                const fileNameText = document.getElementById('fileNameText');
                const uploadButtonLabel = document.getElementById('uploadButtonLabel');

                if (pluginSettings.backgroundImageFile) {
                    const filePath = pluginSettings.backgroundImageFile
                    const fileName = filePath.split('/').pop();

                    // display the file name
                    fileNameText.textContent = fileName;
                    fileNameDisplay.style.display = 'flex';
                    uploadButtonLabel.style.display = 'none';

                    // create a hidden input for the existing file
                    const hiddenInput = document.createElement("input");
                    hiddenInput.type = "hidden";
                    hiddenInput.name = "backgroundImageFile";
                    hiddenInput.value = filePath;
                    hiddenInput.id = `hidden-file-name`;
                    hiddenInput.setAttribute('delete-on-submit', '');
                    document.getElementById("hiddenFileInput").appendChild(hiddenInput);
                } else {
                    fileNameDisplay.style.display = 'none';
                    uploadButtonLabel.style.display = 'block';
                }

                let selectedFrameOption = document.querySelector(`.image-option[data-face-name="${pluginSettings.selectedFrame}"]`);
                selectedFrame(selectedFrameOption);
            } else {
                // set default values
                let selectedFrameOption = document.querySelector('.image-option');
                selectedFrame(selectedFrameOption);

                // Set default margins when creating a new instance
                const defaultMargin = "5";
                const topMarginInput = document.getElementById('topMargin');
                const bottomMarginInput = document.getElementById('bottomMargin');
                const leftMarginInput = document.getElementById('leftMargin');
                const rightMarginInput = document.getElementById('rightMargin');

                if (topMarginInput) topMarginInput.value = defaultMargin;
                if (bottomMarginInput) bottomMarginInput.value = defaultMargin;
                if (leftMarginInput) leftMarginInput.value = defaultMargin;
                if (rightMarginInput) rightMarginInput.value = defaultMargin;
            }
        });
    </script>
</head>
<body>
    <main>
    <div class="frame">
        <!-- Back Button -->
        {% from 'macros/icons.html' import icon %}
        <a href="{{ url_for('main.main_page') }}" class="back-button" aria-label="Home">{{ icon('squares-four', 'icon-image') | safe }}<span class="sr-only">Home</span></a>

        <!-- Plugin Title and Icon -->
        <div class="app-header">
            {% from 'macros/icons.html' import icon %}
            {% set plugin_icon_map = {
                'ai_image': 'magic-wand',
                'ai_text': 'text-t',
                'weather': 'cloud-sun',
                'calendar': 'calendar-blank',
                'clock': 'clock',
                'newspaper': 'newspaper-clipping',
                'apod': 'planet',
                'unsplash': 'images-square',
                'image_url': 'link-simple',
                'image_upload': 'upload-simple',
                'image_folder': 'folder-simple',
                'screenshot': 'monitor',
                'wpotd': 'book-open-text',
                'comic': 'mask-happy'
            } %}
            {% set ph_icon = plugin_icon_map.get(plugin.id, None) %}
            {% if ph_icon %}{{ icon(ph_icon, 'app-icon') }}{% else %}<img src="{{ url_for('plugin.image', plugin_id=plugin.id, filename='icon.png') }}" alt="{{ plugin.display_name }} icon" class="app-icon">{% endif %}
            <h1 class="app-title">{{ plugin.display_name }}</h1>
            <button id="themeToggle" class="header-button icon" type="button" title="Toggle theme" aria-label="Toggle theme">
                <svg class="theme-icon sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="5" stroke="currentColor"></circle>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor"></path>
                </svg>
                <svg class="theme-icon moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor"></path>
                </svg>
            </button>
            {% if api_key and api_key.required %}
            <a class="api-key-label" href="{{ url_for('settings.api_keys_page') }}" title="{{api_key.service}} (Set {{api_key.expected_key}} in API Keys)">Requires API Key</a>
            {% endif %}
            {% from 'macros/icons.html' import icon %}
            <button class="header-button icon" type="button" title="Last progress" aria-label="Show last progress" onclick="showLastProgress()">{{ icon('clock-counter-clockwise', 'icon-image') | safe }}</button>
            <div id="loadingIndicator" class="loading-indicator"></div>
        </div>
        <div class="separator"></div>

        <!-- Status: current display vs this plugin instance -->
        {% set fit = (config.get('preview_size_mode') == 'fit') %}
        <div class="status-bar">
            <!-- Compact current display thumbnail on the left -->
            <div class="status-card compact">
                <div class="status-title">Current display</div>
                <div class="status-body">
                    <div class="image-container {% if not fit %}native{% endif %}" id="currentPreviewContainer">
                        <div id="previewSkeleton" class="img-skeleton" aria-hidden="true"></div>
                        <img id="previewImage" src="{{ url_for('main.preview_image') }}" alt="Current Image" width="{{ resolution[0] }}" height="{{ resolution[1] }}"
                             {% if not fit %}style="width: {{ resolution[0] }}px; height: {{ resolution[1] }}px;"{% endif %}>
                        <div id="deviceFrameOverlay" class="device-frame-overlay" aria-hidden="true"></div>
                    </div>
                </div>
                <div class="status-meta">
                    <span class="label">Updated</span>
                    <span id="currentDisplayTime" class="value">—</span>
                </div>
            </div>
            <!-- Full, non-cropped plugin instance preview on the right -->
            <div class="status-card instance">
                <div class="status-title">This plugin instance</div>
                <div class="status-body">
                    {% if plugin_instance %}
                    <div class="img-skeleton" aria-hidden="true" style="width:100%;"></div>
                    <img id="instancePreviewImage" src="#" alt="Latest for this instance" loading="lazy" onload="this.previousElementSibling.style.display='none'" onerror="this.style.display='none';this.previousElementSibling.style.display='none';document.getElementById('instancePreviewFallback').style.display='block'">
                    <div id="instancePreviewFallback" class="status-placeholder" style="display:none;">
                        No saved image found for this instance yet.
                        {% if plugin_instance and plugin_instance_playlist %}
                        <div style="margin-top:6px;"><button type="button" class="action-button compact" aria-label="Display this instance now" onclick="displayInstanceNow()">Display Instance</button></div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="status-placeholder">Save or select an instance to see its latest image.</div>
                    {% endif %}
                </div>
                <div class="status-meta">
                    <span class="label">Last generated</span>
                    <span id="instanceLastTime" class="value">—</span>
                </div>
            </div>
        </div>
        <div class="separator"></div>

        <div id="pluginMeta" class="image-meta" style="display:none; margin-top: 8px;"><div id="pluginMetaContent"></div></div>

        <!-- Include plugin settings -->
        <form id = "settingsForm" class="settings-form" onsubmit="return false;">
            <div class="settings-container">
                {% include settings_template %}

                <!-- Collapsible Style Settings Section -->
                {% if style_settings %}
                <div class="collapsible">
                    <button type="button" class="collapsible-header" onclick="toggleCollapsible(this)">
                        Style <span class="collapsible-icon">▼</span>
                    </button>
                    <div class="settings-container collapsible-content">
                        <div class="form-group">
                            
                            <div class="form-group nowrap">
                                <label class="form-label">Frame:</label>
                                <div id="frame-selection" class="image-grid">
                                    {% for frame in frame_styles %}
                                    <div
                                        class="image-option"
                                        data-face-name="{{ frame.name }}"
                                        onclick="selectedFrame(this)"
                                    >
                                        <img
                                            src="{{ url_for('plugin.image', plugin_id='base_plugin', filename=frame.icon) }}"
                                            alt="{{ frame.name }}"
                                        />
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="selected-frame" name="selectedFrame" value="{{ frame_styles[0].name }}" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Margins:</label>
                                <div class="form-group nowrap">
                                    <label for="topMargin" class="form-label">Top</label>
                                    <input type="number" class="form-input" id="topMargin" name="topMargin" min="0" max="100" step="5">px
                                </div>
                                <div class="form-group nowrap">
                                    <label for="bottomMargin" class="form-label">Bottom</label>
                                    <input type="number" class="form-input" id="bottomMargin" name="bottomMargin" min="0" max="100" step="5">px
                                </div>
                                <div class="form-group nowrap">
                                    <label for="leftMargin" class="form-label">Left</label>
                                    <input type="number" class="form-input" id="leftMargin" name="leftMargin" min="0" max="100" step="5">px
                                </div>
                                <div class="form-group nowrap">
                                    <label for="rightMargin" class="form-label">Right</label>
                                    <input type="number" class="form-input" id="rightMargin" name="rightMargin" min="0" max="100" step="5">px
                                </div>
                            </div>
                        </div>    
                        
                        <!-- Background Color Option -->
                        <div class="form-group">
                            <label class="form-label">Background:</label>
                            <div class="form-group nowrap">
                                <label>
                                    <input type="radio" name="backgroundOption" value="color" checked>
                                    Color
                                </label>
                                <input type="color" id="backgroundColor" name="backgroundColor" class="color-picker" value="#ffffff" aria-label="Background color">
                            </div>
                            <div class="form-group nowrap">
                                <label>
                                    <input type="radio" name="backgroundOption" value="image">
                                    Image
                                </label>
                                <label for="imageUpload" class="form-input file-upload-label" id="uploadButtonLabel">Upload Image</label>
                                <input type="file" clear-on-submit id="imageUpload" name="backgroundImageFile" accept="image/*" class="file-upload-input" onchange="showFileName()">
                                <div id="fileName" class="file-name" style="display: none;">
                                    <span id="fileNameText"></span>
                                    <button type="button" id="removeFileButton" class="remove-btn" onclick="removeFile()">X</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden input fields to store existing file data -->
                        <div id="hiddenFileInput"></div>
                        
                        <!-- Text Color Picker -->
                        <div class="form-group">
                            <label for="textColor" class="form-label">Text Color:</label>
                            <input type="color" id="textColor" name="textColor" class="color-picker" value="#000000">
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Hidden input to pass plugin id -->
            <input type="hidden" name="plugin_id" value="{{ plugin.id }}">
            {% if plugin_instance %}
            <input type="hidden" name="instance_name" value="{{ plugin_instance }}">
            {% endif %}

            <div class="buttons-container" style="align-items:center;flex-wrap:wrap;">
                <label class="form-label" for="toggleDeviceFrame" style="display:flex;align-items:center;gap:6px;min-width:fit-content;">
                    <input type="checkbox" id="toggleDeviceFrame" aria-label="Show device frame"> Show device frame
                </label>
                <button type="button" onclick="handleAction()" class="action-button left">Update Now</button>
                <button type="button" onclick="handleAction('save_settings')" class="action-button center">Save Settings</button>
                {% if plugin_instance %}
                    <button type="button" onclick="handleAction('update_instance')" class="action-button right">Update Instance</button>
                {% else %}
                    <button type="button" onclick="openModal('scheduleModal')" class="action-button right">Add to Playlist</button>
                {% endif %}
            </div>
            <div class="form-help" style="margin-top:8px;">
                Saving does not schedule recurrence. Use <strong>Add to Playlist</strong> to have this plugin run automatically.
            </div>
        </form>
    </div>

    <!-- Success/Error Modal -->
    {% include 'response_modal.html' %}

    <!-- Schedule Configuration Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('scheduleModal')">×</span>
            <h2>Add to Playlist</h2>
            <div class="separator"></div>
            <form id="scheduleForm" class="settings-form">
                <div class="form-group">
                    <label for="playlist" class="form-label">Playlist:</label>
                    <select id="playlist" name="playlist" class="form-input">
                        {% for playlist_name in playlists %}
                        <option value="{{playlist_name}}">{{playlist_name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="instance" class="form-label">Instance Name:</label>
                    <input type="text" id="instance" name="instance_name" placeholder="Type something..." required class="form-input">
                </div>
                <div class="form-group">
                    <label>Refresh</label>
                    <span title="Determines how often the data and image should be refreshed.">ⓘ</span>
                </div>
                <div class="form-group nowrap">
                    <input type="radio" id="refreshTypeInterval" name="refreshType" value="interval" checked>
                    <label for="refreshTypeInterval">Every</label>
                    <input type="number" id="interval" name="interval" class="form-input" required min="1" placeholder="Enter a number" aria-label="Interval value">
                    <select id="unit" name="unit" class="form-input" required aria-label="Time unit">
                        <option value="minute">Minute</option>
                        <option value="hour">Hour</option>
                        <option value="day">Day</option>
                    </select>
                </div>
                <div class="form-group nowrap">
                    <input type="radio" id="refreshTypeScheduled" name="refreshType" value="scheduled">
                    <label for="refreshTypeScheduled">Daily at</label>
                    <input id="scheduled" class="time-input" type="time" name="refreshTime" step="900" aria-label="Scheduled time">
                </div>
            </form>
            <div class="buttons-container">
                <button type="button" onclick="handleAction('add_to_playlist')" class="action-button">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Image preview (lightbox) for plugin page -->
    <div id="imagePreviewModal" class="modal image-modal" role="dialog" aria-modal="true" aria-labelledby="imagePreviewTitle" style="display:none;">
        <div class="modal-content">
            <span class="close-button" onclick="(function(){ const m=document.getElementById('imagePreviewModal'); if(m) m.style.display='none'; })()" aria-label="Close">×</span>
            <img id="imagePreviewImg" alt="Large preview" style="max-width:92vw; max-height:85vh; display:block; margin:0 auto;"/>
        </div>
    </div>
    <div id="requestProgress" class="progress-block" style="display:none;">
        <div class="progress-header">
            <span id="requestProgressText">Preparing…</span>
            <button type="button" class="progress-close" aria-label="Close progress" onclick="(function(){ const el = document.getElementById('requestProgress'); if (el) el.style.display='none'; })()">×</button>
        </div>
        <div class="progress-meta">
            <span class="meta-item"><span>Now:</span> <span id="requestProgressClock" class="value">—</span></span>
            <span class="meta-item"><span>Elapsed:</span> <span id="requestProgressElapsed" class="value">0s</span></span>
        </div>
        <div class="progress-bar"><div id="requestProgressBar" class="progress-fill" style="width: 10%;"></div></div>
        <ol id="requestProgressList" class="progress-log" aria-live="polite"></ol>
    </div>
    <script>
        // Lightbox + native-size toggle behavior for plugin page previews
        (function(){
            const previewImg = document.getElementById('previewImage');
            const instanceImg = document.getElementById('instancePreviewImage');
            const container = previewImg && previewImg.parentElement;
            const nativeWidth = {{ resolution[0] }};
            const nativeHeight = {{ resolution[1] }};

            function openImagePreview(url, alt){
                const m = document.getElementById('imagePreviewModal');
                const img = document.getElementById('imagePreviewImg');
                if (!m || !img) return;
                img.src = url;
                img.alt = alt || 'Large preview';
                m.style.display = 'block';
                function esc(e){ if (e.key === 'Escape') { closeImagePreview(); document.removeEventListener('keydown', esc); } }
                document.addEventListener('keydown', esc);
            }
            function closeImagePreview(){ const m = document.getElementById('imagePreviewModal'); if (m) m.style.display = 'none'; }
            window.closeImagePreview = closeImagePreview;

            // Close when clicking outside modal content
            window.addEventListener('click', function(ev){
                const m = document.getElementById('imagePreviewModal');
                if (ev.target === m) { closeImagePreview(); }
            });

            if (previewImg){
                // Single click opens lightbox
                previewImg.addEventListener('click', function(){ if (previewImg.src) openImagePreview(previewImg.src, previewImg.alt); });
                // Double click toggles native size in-page (retains previous behavior)
                if (container){
                    previewImg.addEventListener('dblclick', function(e){
                        e.preventDefault();
                        if (container.classList.contains('native')) {
                            container.classList.remove('native');
                            previewImg.removeAttribute('style');
                        } else {
                            container.classList.add('native');
                            previewImg.style.width = nativeWidth + 'px';
                            previewImg.style.height = nativeHeight + 'px';
                        }
                    });
                }
            }
            if (instanceImg){
                instanceImg.style.cursor = 'zoom-in';
                instanceImg.addEventListener('click', function(){ if (instanceImg.src && instanceImg.style.display !== 'none'){ openImagePreview(instanceImg.src, instanceImg.alt); } });
            }

            // Device frame overlay toggle
            const toggle = document.getElementById('toggleDeviceFrame');
            const overlay = document.getElementById('deviceFrameOverlay');
            if (toggle && overlay){
                try { overlay.style.backgroundImage = "url('" + {{ url_for('plugin.image', plugin_id='base_plugin', filename='frames/device_frame.png') | tojson }} + "')"; } catch(e) {}
                toggle.addEventListener('change', function(){
                    const parent = document.getElementById('currentPreviewContainer');
                    if (this.checked) parent.classList.add('show-frame'); else parent.classList.remove('show-frame');
                });
            }
        })();
    </script>
    <script>
        async function displayInstanceNow(){
            try {
                const payload = {
                    playlist_name: '{{ plugin_instance_playlist or '' }}',
                    plugin_id: '{{ plugin.id }}',
                    plugin_instance: '{{ plugin_instance or '' }}'
                };
                const resp = await fetch('{{ url_for("plugin.display_plugin_instance") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await resp.json();
                if (!resp.ok) {
                    showResponseModal('failure', `Error!  ${result.error}`);
                } else {
                    showResponseModal('success', `Success! ${result.message}`);
                    // give backend a moment, then refresh both previews
                    setTimeout(() => { refreshPreviewImage(); }, 400);
                    setTimeout(() => { const el = document.getElementById('instancePreviewImage'); if (el) el.src = el.src.split('?')[0] + '?t=' + Date.now(); }, 450);
                }
            } catch (e){
                console.error(e);
                showResponseModal('failure', 'Failed to display instance');
            }
        }
    </script>
    </main>
</body>
</html>

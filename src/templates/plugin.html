<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ plugin.display_name }} Settings</title>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
    <script src="{{ url_for('static', filename='scripts/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>
    

    <script>
        const pluginSettings = {{ plugin_settings | tojson if plugin_settings else {} }};
        const pluginInstanceName ='{{ plugin_instance }}';
        const hasPluginSettings = !!(pluginSettings && Object.keys(pluginSettings).length);
        // Treat either editing an instance or having saved (non-instance) settings as "load settings"
        const loadPluginSettings = (pluginInstanceName != '') || hasPluginSettings;
        const styleSettings = {{ style_settings | default(false) | tojson }};
        const previewUrl = '{{ url_for("main.preview_image") }}';
        const refreshInfoUrl = '{{ url_for("main.refresh_info") }}';
        const instancePreviewUrl = (pluginId, instanceName) => {
            if (!pluginId || !instanceName) return null;
            return '{{ url_for("plugin.plugin_instance_image", plugin_id="__PID__", instance_name="__INST__") }}'
                .replace('__PID__', pluginId)
                .replace('__INST__', instanceName);
        };

        let uploadedFiles = {};

        async function handleAction(action) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const progress = document.getElementById('requestProgress');
            const progressText = document.getElementById('requestProgressText');
            function setStep(text, pct){
                if (progress) progress.style.display = 'block';
                if (progressText) progressText.textContent = text;
                const bar = document.getElementById('requestProgressBar');
                if (bar && typeof pct === 'number') bar.style.width = pct + '%';
            }
            loadingIndicator.style.display = 'block';
            setStep('Preparing…', 10);

            // Allow plugin-specific client-side validation (e.g., require lat/long for Weather)
            try {
                if (typeof window.validatePluginSettings === 'function') {
                    const isValid = window.validatePluginSettings(action);
                    if (!isValid) {
                        loadingIndicator.style.display = 'none';
                        if (progress) progress.style.display = 'none';
                        return; // abort submission
                    }
                }
            } catch (e) {
                console.warn('Plugin validation threw an error:', e);
            }

            // Gather plugin settings form data
            const form = document.getElementById('settingsForm');
            const scheduleForm = document.getElementById('scheduleForm');

            const formData = new FormData(form);
            let url = '{{ url_for("plugin.update_now") }}';
            let method = 'POST';
            let clearFormOnSubmit = true;
            
            // Add uploaded files to the form under its key
            Object.keys(uploadedFiles).forEach(key => {
                if (uploadedFiles[key].length > 0) {
                    uploadedFiles[key].forEach(file => {
                        formData.append(key, file);
                    });
                }
            });

            if (action == "add_to_playlist"){
                url = '{{ url_for('playlist.add_plugin') }}';
                const scheduleFormData = new FormData(scheduleForm);
                const scheduleData = {};
                for (const [key, value] of scheduleFormData.entries()) {
                    scheduleData[key] = value;
                }
                formData.append("refresh_settings", JSON.stringify(scheduleData));
            } else if (action == "update_instance") {
                url = "{{ url_for('plugin.update_plugin_instance', instance_name='') }}" + pluginInstanceName,
                method = 'PUT'
                clearFormOnSubmit = false
            } else if (action == "save_settings") {
                url = '{{ url_for("plugin.save_plugin_settings") }}';
                clearFormOnSubmit = false
            }

            // Send data to the server
            try {
                setStep('Sending…', 30);
                const response = await fetch(url, {method: method, body: formData});
                setStep('Waiting (device)…', 60);
                const result = await response.json();
                // Handle the response
                if (response.ok) {
                    // Show metrics if present
                    if (result && result.metrics) {
                        const m = result.metrics;
                        const text = `Request ${m.request_ms} ms • Generate ${m.generate_ms ?? '-'} ms • Preprocess ${m.preprocess_ms ?? '-'} ms • Display ${m.display_ms ?? '-'} ms`;
                        if (progressText) progressText.textContent = text;
                    }
                    setStep('Display updating…', 90);
                    showResponseModal('success', `Success! ${result.message}`);
                    // Trigger preview refresh shortly after success
                    setTimeout(() => { refreshPreviewImage(); }, 250);
                } else {
                    showResponseModal('failure', `Error!  ${result.error}`);
                }
                closeModal('scheduleModal');

                if (clearFormOnSubmit) {
                    form.reset()
                    uploadedFiles = {};
                    document.querySelectorAll('input[clear-on-submit]').forEach(input => {
                        input.value = '';
                        input.dispatchEvent(new Event('change'));
                    });
                    document.querySelectorAll('[delete-on-submit]').forEach(div => {
                        div.remove();
                    });
                    if (action == "add_to_playlist"){
                        scheduleForm.reset()
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            } finally {
                // Hide loading indicator after the action is complete
                loadingIndicator.style.display = 'none';
                setStep('Done', 100);
                setTimeout(() => { if (progress) progress.style.display = 'none'; }, 1200);
            }
        }
        async function refreshPreviewImage(){
            const img = document.getElementById('previewImage');
            const skel = document.getElementById('previewSkeleton');
            if (img){ if (skel) skel.style.display=''; img.src = previewUrl + '?t=' + Date.now(); }
            // Update current display timestamp/meta
            try {
                const res = await fetch(refreshInfoUrl);
                const info = await res.json();
                // Update current display timestamp
                const ts = info && info.refresh_time ? new Date(info.refresh_time) : null;
                const currTime = document.getElementById('currentDisplayTime');
                if (currTime) currTime.textContent = ts ? ts.toLocaleString() : '—';
                // Update optional plugin meta (e.g., WPOTD)
                const metaDiv = document.getElementById('pluginMeta');
                const metaContent = document.getElementById('pluginMetaContent');
                if (info && info.plugin_id === 'wpotd' && info.plugin_meta) {
                    const m = info.plugin_meta;
                    const date = m.date ? new Date(m.date).toISOString().slice(0,10) : '';
                    const caption = m.caption || '';
                    const link = m.description_url || m.page_url || '';
                    let html = '';
                    if (date) html += `<div><strong>Wikipedia Picture of the Day:</strong> ${date}</div>`;
                    if (caption) html += `<div style=\"margin-top:4px;\">${caption}</div>`;
                    if (link) html += `<div style=\"margin-top:4px;\"><a href=\"${link}\" target=\"_blank\" rel=\"noopener noreferrer\">Learn more</a></div>`;
                    if (html) {
                        metaContent.innerHTML = html;
                        metaDiv.style.display = 'block';
                    } else {
                        metaDiv.style.display = 'none';
                        metaContent.textContent = '';
                    }
                } else {
                    metaDiv.style.display = 'none';
                    metaContent.textContent = '';
                }
            } catch (e) { /* ignore */ }
        }

        function openModal(modal_id) {
            const modal = document.getElementById(modal_id);
            modal.style.display = 'block';
        }
    
        function closeModal(modal_id) {
            const modal = document.getElementById(modal_id);
            modal.style.display = 'none';
        }
    
        // Close modal if the user clicks outside the modal content
        window.onclick = function (event) {
            const modal = document.getElementById('scheduleModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        function toggleCollapsible(button) {
            const content = button.nextElementSibling;
            const icon = button.querySelector(".collapsible-icon");
            button.classList.toggle("active");
            content.style.display = content.style.display === "block" ? "none" : "block";
            icon.textContent = content.style.display === "block" ? "▲" : "▼";
        }

        function selectedFrame(element) {
            // Remove the selected class from any previously selected option
            const previousSelection = document.querySelector('.image-option.selected');
            if (previousSelection) {
                previousSelection.classList.remove('selected');
            }

            // Add the selected class to the clicked option
            element.classList.add('selected');

            // Update the hidden input with the selected frame
            const selectedFaceName = element.getAttribute('data-face-name');
            document.getElementById('selected-frame').value = selectedFaceName;
        }

        function showFileName() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameDisplay = document.getElementById('fileName');
            const fileNameText = document.getElementById('fileNameText');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');
            const removeFileButton = document.getElementById('removeFileButton');
            const file = fileInput.files[0];

            if (file) {
                fileNameText.textContent = `${file.name}`;
                fileNameDisplay.style.display = 'flex';  // Show the file name and remove button
                uploadButtonLabel.style.display = 'none';  // Hide the upload button label
            } else {
                fileNameDisplay.style.display = 'none';  // Hide if no file is selected
                uploadButtonLabel.style.display = 'block';  // Show the upload button label
            }
        }

        function removeFile() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameDisplay = document.getElementById('fileName');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');

            fileInput.value = '';  // Clear the file input
            fileNameDisplay.style.display = 'none';  // Hide the file name and remove button
            uploadButtonLabel.style.display = 'block';  // Show the upload button label

            const hiddenElement = document.getElementById(`hidden-file-name`);
            if (hiddenElement) {
                hiddenElement.remove();
            }
        }

        // populate form values from plugin settings
        document.addEventListener('DOMContentLoaded', () => {
            // Populate top status bar previews and timestamps
            (function initStatusBar(){
                const pluginId = '{{ plugin.id }}';
                const instanceName = pluginInstanceName;
                const instImgEl = document.getElementById('instancePreviewImage');
                const instTimeEl = document.getElementById('instanceLastTime');
                const instUrl = instancePreviewUrl(pluginId, instanceName);
                if (instImgEl && instUrl) {
                    instImgEl.src = instUrl + '?t=' + Date.now();
                }
                const lastStr = '{{ plugin_instance_last_refresh or '' }}';
                if (instTimeEl) {
                    instTimeEl.textContent = lastStr ? new Date(lastStr).toLocaleString() : '—';
                }
                // Also initialize current display timestamp
                refreshPreviewImage();
            })();
            if (!styleSettings){
                return;
            }
            if (loadPluginSettings) {
                if (pluginSettings.topMargin) {
                    document.getElementById('topMargin').value = pluginSettings.topMargin;
                }
                if (pluginSettings.bottomMargin) {
                    document.getElementById('bottomMargin').value = pluginSettings.bottomMargin;
                }
                if (pluginSettings.leftMargin) {
                    document.getElementById('leftMargin').value = pluginSettings.leftMargin;
                }
                if (pluginSettings.rightMargin) {
                    document.getElementById('rightMargin').value = pluginSettings.rightMargin;
                }
                // Populate background options (color or image)
                if (pluginSettings.backgroundOption) {
                    document.querySelector(`input[name="backgroundOption"][value="${pluginSettings.backgroundOption}"]`).checked = true;
                }

                // Set background color
                if (pluginSettings.backgroundColor) {
                    document.getElementById('backgroundColor').value = pluginSettings.backgroundColor;
                }

                // Populate text color
                if (pluginSettings.textColor) {
                    document.getElementById('textColor').value = pluginSettings.textColor;
                }

                // Handle background image selection
                const fileNameDisplay = document.getElementById('fileName');
                const fileNameText = document.getElementById('fileNameText');
                const uploadButtonLabel = document.getElementById('uploadButtonLabel');

                if (pluginSettings.backgroundImageFile) {
                    const filePath = pluginSettings.backgroundImageFile
                    const fileName = filePath.split('/').pop();

                    // display the file name
                    fileNameText.textContent = fileName;
                    fileNameDisplay.style.display = 'flex';
                    uploadButtonLabel.style.display = 'none';

                    // create a hidden input for the existing file
                    const hiddenInput = document.createElement("input");
                    hiddenInput.type = "hidden";
                    hiddenInput.name = "backgroundImageFile";
                    hiddenInput.value = filePath;
                    hiddenInput.id = `hidden-file-name`;
                    hiddenInput.setAttribute('delete-on-submit', '');
                    document.getElementById("hiddenFileInput").appendChild(hiddenInput);
                } else {
                    fileNameDisplay.style.display = 'none';
                    uploadButtonLabel.style.display = 'block';
                }

                let selectedFrameOption = document.querySelector(`.image-option[data-face-name="${pluginSettings.selectedFrame}"]`);
                selectedFrame(selectedFrameOption);
            } else {
                // set default values
                let selectedFrameOption = document.querySelector('.image-option');
                selectedFrame(selectedFrameOption);

                // Set default margins when creating a new instance
                const defaultMargin = "5";
                const topMarginInput = document.getElementById('topMargin');
                const bottomMarginInput = document.getElementById('bottomMargin');
                const leftMarginInput = document.getElementById('leftMargin');
                const rightMarginInput = document.getElementById('rightMargin');

                if (topMarginInput) topMarginInput.value = defaultMargin;
                if (bottomMarginInput) bottomMarginInput.value = defaultMargin;
                if (leftMarginInput) leftMarginInput.value = defaultMargin;
                if (rightMarginInput) rightMarginInput.value = defaultMargin;
            }
        });
    </script>
</head>
<body>
    <div class="frame">
        <!-- Back Button -->
        <button onclick="history.back()" class="back-button">← Back</button>

        <!-- Plugin Title and Icon -->
        <div class="app-header">
            {% from 'macros/icons.html' import icon %}
            {% set plugin_icon_map = {
                'ai_image': 'magic-wand',
                'ai_text': 'text-t',
                'weather': 'cloud-sun',
                'calendar': 'calendar-blank',
                'clock': 'clock',
                'newspaper': 'newspaper-clipping',
                'apod': 'planet',
                'unsplash': 'images-square',
                'image_url': 'link-simple',
                'image_upload': 'upload-simple',
                'image_folder': 'folder-simple',
                'screenshot': 'monitor',
                'wpotd': 'book-open-text',
                'comic': 'mask-happy'
            } %}
            {% set ph_icon = plugin_icon_map.get(plugin.id, None) %}
            {% if ph_icon %}{{ icon(ph_icon, 'app-icon') }}{% else %}<img src="{{ url_for('plugin.image', plugin_id=plugin.id, filename='icon.png') }}" alt="{{ plugin.display_name }} icon" class="app-icon">{% endif %}
            <h1 class="app-title">{{ plugin.display_name }}</h1>
            <button id="themeToggle" class="header-button icon" type="button" title="Toggle theme" aria-label="Toggle theme">
                <svg class="theme-icon sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="5" stroke="currentColor"></circle>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor"></path>
                </svg>
                <svg class="theme-icon moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor"></path>
                </svg>
            </button>
            {% if api_key and api_key.required %}
            <a class="api-key-label" href="{{ url_for('settings.api_keys_page') }}" title="{{api_key.service}} (Set {{api_key.expected_key}} in API Keys)">Requires API Key</a>
            {% endif %}
            <div id="loadingIndicator" class="loading-indicator"></div>
        </div>
        <div class="separator"></div>

        <!-- Status: current display vs this plugin instance -->
        {% set fit = (config.get('preview_size_mode') == 'fit') %}
        <div class="status-bar">
            <div class="status-card">
                <div class="status-title">Current display</div>
                <div class="status-body">
                    <div class="image-container {% if not fit %}native{% endif %}" id="currentPreviewContainer">
                        <div id="previewSkeleton" class="img-skeleton" aria-hidden="true"></div>
                        <img id="previewImage" src="{{ url_for('main.preview_image') }}" alt="Current Image" width="{{ resolution[0] }}" height="{{ resolution[1] }}"
                             {% if not fit %}style="width: {{ resolution[0] }}px; height: {{ resolution[1] }}px;"{% endif %}>
                        <div id="deviceFrameOverlay" class="device-frame-overlay" aria-hidden="true"></div>
                    </div>
                </div>
                <div class="status-meta">
                    <span class="label">Updated</span>
                    <span id="currentDisplayTime" class="value">—</span>
                </div>
            </div>
            <div class="status-card">
                <div class="status-title">This plugin instance</div>
                <div class="status-body">
                    {% if plugin_instance %}
                    <div class="img-skeleton" aria-hidden="true" style="width:100%;height:160px;"></div>
                    <img id="instancePreviewImage" src="#" alt="Latest for this instance" loading="lazy" onload="this.previousElementSibling.style.display='none'" onerror="this.style.display='none';this.previousElementSibling.style.display='none';document.getElementById('instancePreviewFallback').style.display='block'">
                    <div id="instancePreviewFallback" class="status-placeholder" style="display:none;">
                        No saved image found for this instance yet.
                        {% if plugin_instance and plugin_instance_playlist %}
                        <div style="margin-top:6px;"><button type="button" class="action-button compact" aria-label="Display this instance now" onclick="displayInstanceNow()">Display Instance</button></div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="status-placeholder">Save or select an instance to see its latest image.</div>
                    {% endif %}
                </div>
                <div class="status-meta">
                    <span class="label">Last generated</span>
                    <span id="instanceLastTime" class="value">—</span>
                </div>
            </div>
        </div>
        <div class="separator"></div>

        <div id="pluginMeta" class="image-meta" style="display:none; margin-top: 8px;"><div id="pluginMetaContent"></div></div>

        <!-- Include plugin settings -->
        <form id = "settingsForm" class="settings-form" onsubmit="return false;">
            <div class="settings-container">
                {% include settings_template %}

                <!-- Collapsible Style Settings Section -->
                {% if style_settings %}
                <div class="collapsible">
                    <button type="button" class="collapsible-header" onclick="toggleCollapsible(this)">
                        Style <span class="collapsible-icon">▼</span>
                    </button>
                    <div class="settings-container collapsible-content">
                        <div class="form-group">
                            
                            <div class="form-group nowrap">
                                <label class="form-label">Frame:</label>
                                <div id="frame-selection" class="image-grid">
                                    {% for frame in frame_styles %}
                                    <div
                                        class="image-option"
                                        data-face-name="{{ frame.name }}"
                                        onclick="selectedFrame(this)"
                                    >
                                        <img
                                            src="{{ url_for('plugin.image', plugin_id='base_plugin', filename=frame.icon) }}"
                                            alt="{{ frame.name }}"
                                        />
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="selected-frame" name="selectedFrame" value="{{ frame_styles[0].name }}" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Margins:</label>
                                <div class="form-group nowrap">
                                    <label for="topMargin" class="form-label">Top</label>
                                    <input type="number" class="form-input" id="topMargin" name="topMargin" min="0" max="100" step="5">px
                                </div>
                                <div class="form-group nowrap">
                                    <label for="bottomMargin" class="form-label">Bottom</label>
                                    <input type="number" class="form-input" id="bottomMargin" name="bottomMargin" min="0" max="100" step="5">px
                                </div>
                                <div class="form-group nowrap">
                                    <label for="leftMargin" class="form-label">Left</label>
                                    <input type="number" class="form-input" id="leftMargin" name="leftMargin" min="0" max="100" step="5">px
                                </div>
                                <div class="form-group nowrap">
                                    <label for="rightMargin" class="form-label">Right</label>
                                    <input type="number" class="form-input" id="rightMargin" name="rightMargin" min="0" max="100" step="5">px
                                </div>
                            </div>
                        </div>    
                        
                        <!-- Background Color Option -->
                        <div class="form-group">
                            <label class="form-label">Background:</label>
                            <div class="form-group nowrap">
                                <label>
                                    <input type="radio" name="backgroundOption" value="color" checked>
                                    Color
                                </label>
                                <input type="color" id="backgroundColor" name="backgroundColor" class="color-picker" value="#ffffff">
                            </div>
                            <div class="form-group nowrap">
                                <label>
                                    <input type="radio" name="backgroundOption" value="image">
                                    Image
                                </label>
                                <label for="imageUpload" class="form-input file-upload-label" id="uploadButtonLabel">Upload Image</label>
                                <input type="file" clear-on-submit id="imageUpload" name="backgroundImageFile" accept="image/*" class="file-upload-input" onchange="showFileName()">
                                <div id="fileName" class="file-name" style="display: none;">
                                    <span id="fileNameText"></span>
                                    <button type="button" id="removeFileButton" class="remove-btn" onclick="removeFile()">X</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden input fields to store existing file data -->
                        <div id="hiddenFileInput"></div>
                        
                        <!-- Text Color Picker -->
                        <div class="form-group">
                            <label for="textColor" class="form-label">Text Color:</label>
                            <input type="color" id="textColor" name="textColor" class="color-picker" value="#000000">
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Hidden input to pass plugin id -->
            <input type="hidden" name="plugin_id" value="{{ plugin.id }}">
            {% if plugin_instance %}
            <input type="hidden" name="instance_name" value="{{ plugin_instance }}">
            {% endif %}

            <div class="buttons-container">
                <label class="form-label" for="toggleDeviceFrame" style="display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="toggleDeviceFrame" aria-label="Show device frame"> Show device frame
                </label>
                <button type="button" onclick="handleAction()" class="action-button left">Update Now</button>
                <button type="button" onclick="handleAction('save_settings')" class="action-button center">Save Settings</button>
                {% if plugin_instance %}
                    <button type="button" onclick="handleAction('update_instance')" class="action-button right">Update Instance</button>
                {% else %}
                    <button type="button" onclick="openModal('scheduleModal')" class="action-button right">Add to Playlist</button>
                {% endif %}
            </div>
            <div class="form-help" style="margin-top:8px;">
                Saving does not schedule recurrence. Use <strong>Add to Playlist</strong> to have this plugin run automatically.
            </div>
        </form>
    </div>

    <!-- Success/Error Modal -->
    {% include 'response_modal.html' %}

    <!-- Schedule Configuration Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('scheduleModal')">×</span>
            <h2>Add to Playlist</h2>
            <div class="separator"></div>
            <form id="scheduleForm" class="settings-form">
                <div class="form-group">
                    <label for="playlist" class="form-label">Playlist:</label>
                    <select id="playlist" name="playlist" class="form-input">
                        {% for playlist_name in playlists %}
                        <option value="{{playlist_name}}">{{playlist_name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="instance" class="form-label">Instance Name:</label>
                    <input type="text" id="instance" name="instance_name" placeholder="Type something..." required class="form-input">
                </div>
                <div class="form-group">
                    <label>Refresh</label>
                    <span title="Determines how often the data and image should be refreshed.">ⓘ</span>
                </div>
                <div class="form-group nowrap">
                    <input type="radio" name="refreshType" value="interval" checked>
                    <label for="interval">Every</label>
                    <input type="number" id="interval" name="interval" class="form-input" required min="1" placeholder="Enter a number">
                    <select id="unit" name="unit" class="form-input" required>
                        <option value="minute">Minute</option>
                        <option value="hour">Hour</option>
                        <option value="day">Day</option>
                    </select>
                </div>
                <div class="form-group nowrap">
                    <input type="radio" name="refreshType" value="scheduled">
                    <label for="scheduled">Daily at </label>
                    <input id="scheduled" class="time-input" type="time" name="refreshTime" step="900">
                </div>
            </form>
            <div class="buttons-container">
                <button type="button" onclick="handleAction('add_to_playlist')" class="action-button">Save</button>
            </div>
        </div>
    </div>
    <div id="requestProgress" class="progress-block" style="display:none;">
        <div class="progress-header">
            <span id="requestProgressText">Preparing…</span>
        </div>
        <div class="progress-bar"><div id="requestProgressBar" class="progress-fill" style="width: 10%;"></div></div>
    </div>
    <script>
        // Click to toggle between fit and native resolution on plugin page
        (function(){
            const previewImg = document.getElementById('previewImage');
            const container = previewImg && previewImg.parentElement;
            if (!previewImg || !container) return;
            const nativeWidth = {{ resolution[0] }};
            const nativeHeight = {{ resolution[1] }};
            previewImg.addEventListener('click', function(){
                if (container.classList.contains('native')) {
                    container.classList.remove('native');
                    previewImg.removeAttribute('style');
                } else {
                    container.classList.add('native');
                    previewImg.style.width = nativeWidth + 'px';
                    previewImg.style.height = nativeHeight + 'px';
                }
            });
            // Device frame overlay toggle
            const toggle = document.getElementById('toggleDeviceFrame');
            const overlay = document.getElementById('deviceFrameOverlay');
            if (toggle && overlay){
                // Choose a frame asset; using neutral SVG/PNG path in base plugin assets if present
                try { overlay.style.backgroundImage = "url('" + {{ url_for('plugin.image', plugin_id='base_plugin', filename='frames/device_frame.png') | tojson }} + "')"; } catch(e) {}
                toggle.addEventListener('change', function(){
                    const parent = document.getElementById('currentPreviewContainer');
                    if (this.checked) parent.classList.add('show-frame'); else parent.classList.remove('show-frame');
                });
            }
        })();
    </script>
    <script>
        async function displayInstanceNow(){
            try {
                const payload = {
                    playlist_name: '{{ plugin_instance_playlist or '' }}',
                    plugin_id: '{{ plugin.id }}',
                    plugin_instance: '{{ plugin_instance or '' }}'
                };
                const resp = await fetch('{{ url_for("plugin.display_plugin_instance") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await resp.json();
                if (!resp.ok) {
                    showResponseModal('failure', `Error!  ${result.error}`);
                } else {
                    showResponseModal('success', `Success! ${result.message}`);
                    // give backend a moment, then refresh both previews
                    setTimeout(() => { refreshPreviewImage(); }, 400);
                    setTimeout(() => { const el = document.getElementById('instancePreviewImage'); if (el) el.src = el.src.split('?')[0] + '?t=' + Date.now(); }, 450);
                }
            } catch (e){
                console.error(e);
                showResponseModal('failure', 'Failed to display instance');
            }
        }
    </script>
</body>
</html>

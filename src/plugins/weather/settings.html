<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<div class="form-group">
    <label class="form-label">Location: </label>
    <div class="form-group">
        <span>Latitude </span>
        <input readonly type="text" id="latitude" name="latitude" class="form-input" />
    </div>
    <div class="form-group">
        <span>Longitude </span>
        <input readonly type="text" id="longitude" name="longitude" class="form-input" />
    </div>
    <button type="button" id="openMap" class="action-button compact">Select Location</button>
    <button type="button" id="useBrowserLocation" class="action-button compact is-secondary" title="Use this browser's current location">Use Browser Location</button>
</div>

<div class="form-group">
    <label for="weatherProvider" class="form-label">Weather Provider:</label>
    <select id="weatherProvider" name="weatherProvider" class="form-input" onchange="updateTitleOptions(this.value)">
        <option value="OpenWeatherMap">OpenWeatherMap</option>
        <option value="OpenMeteo">Open-Meteo</option>
    </select>

    <label for="units" class="form-label">Units:</label>
    <select id="units" name="units" class="form-input">
        <option value="imperial">Imperial (°F)</option>
        <option value="metric">Metric (°C)</option>
        <option value="standard">Standard (K)</option>
    </select>
</div>

<div class="form-group" id="titleOptionWrapper">
    <label class="form-label">Title:</label>

    <div class="form-group">
        <input type="radio" id="title-location" name="titleSelection" value="location">
        <label for="title-location">Location</label>

        <input type="radio" id="title-custom" name="titleSelection" value="custom">
        <label for="title-custom">Custom</label>
        <input type="text" id="customTitle" name="customTitle" class="form-input" placeholder="Type something..." />
    </div>
</div>

<div class="form-group">
    <label for="displayMetrics" class="form-label">Display: </label>

    <div class="form-group">
      <input type="checkbox" id="displayRefreshTime" name="displayRefreshTime" onclick="this.value=this.checked ? 'true' : 'false';">
      <span>Refresh Time</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayMetrics" name="displayMetrics" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Metrics</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayGraph" name="displayGraph" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Weather Graph</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayRain" name="displayRain" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Rain Amount</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="moonPhase" name="moonPhase" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Moon Phase</span>
    </div>

    <div class="form-group">
        <input type="checkbox" id="displayForecast" name="displayForecast" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Forecast</span>
        <select id="forecastDays" name="forecastDays" class="form-input">
            <option value=3>3</option>
            <option value=5>5</option>
            <option value=7>7</option>
        </select>
        days
    </div>

    <div class="form-group">
        <label for="weatherTimeZone" class="form-label">Time Zone:</label>
        <select id="weatherTimeZone" name="weatherTimeZone" class="form-input">
            <option value="locationTimeZone">Use Location Time Zone</option>
            <option value="localTimeZone">Use Local Time Zone</option>
        </select>
    </div>

</div>

<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">×</span>
        <h2 id="modalTitle">Select Location</h2>
        <div class="separator"></div>
        <div id="map" style="width: 100%; height: 200px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Save</button>
    </div>
</div>

<script>

    function updateTitleOptions(provider) {
        const titleLocationRadio = document.getElementById('title-location');
        const titleLocationLabel = document.querySelector('label[for="title-location"]');
        const titleCustomRadio = document.getElementById('title-custom');
        const customTitleInput = document.getElementById('customTitle');
        const titleTimeZone = document.getElementById('weatherTimeZone');
        const titleTimeZoneLabel = document.querySelector('label[for="weatherTimeZone"]');

        if (provider === 'OpenMeteo') {
            // Hide or disable "Location" radio option
            titleLocationRadio.style.display = 'none';
            titleLocationLabel.style.display = 'none';
            titleLocationRadio.disabled = true;
            titleTimeZone.style.display = 'none';
            titleTimeZoneLabel.style.display = 'none';
            titleTimeZone.disabled = true;

            // Select and enable "Custom"
            titleCustomRadio.checked = true;
            titleCustomRadio.disabled = false;
            customTitleInput.disabled = false;
        } else {
            // Show and enable both options
            titleLocationRadio.style.display = '';
            titleLocationLabel.style.display = '';
            titleLocationRadio.disabled = false;

            titleCustomRadio.disabled = false;
            customTitleInput.disabled = false;

            titleTimeZone.style.display = '';
            titleTimeZoneLabel.style.display = '';
            titleTimeZone.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {

        const OSM_TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $mapModal = document.querySelector('#mapModal');
        const $closeMap = document.querySelector('#closeMap');

        let latitude = +$latitude.value || 0;
        let longitude = +$longitude.value || 0;
        let zoom = (latitude && longitude) ? 4.5 : 2.5;

        function updateZoom() {
            zoom = (latitude && longitude && latitude !== 0 && longitude !== 0) ? 4.5 : 2.5;
        }
        let selectedTitle = 'location';
        let weatherProvider = 'OpenWeatherMap';

        let map, marker;

        $openMap.addEventListener('click', () => {
            openModal('mapModal')
            setTimeout(() => {
                if (!map) {
                    map = L.map('map').setView([latitude, longitude], zoom);
                    L.tileLayer(OSM_TILE_URL).addTo(map);
                    marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

                    map.on('click', event => {
                        marker.setLatLng(event.latlng);
                    });
                } else {
                    // Update existing map view and marker position
                    map.setView([latitude, longitude], zoom);
                    marker.setLatLng([latitude, longitude]);
                }
            }, 100);
        });

        $closeMap.addEventListener('click', () => {
            const position = marker.getLatLng().wrap();
            $latitude.value = position.lat;
            $longitude.value = position.lng;
            latitude = position.lat;
            longitude = position.lng;
            updateZoom();
            closeModal('mapModal');
        });

        if (loadPluginSettings) {
            document.getElementById('latitude').value = pluginSettings.latitude;
            document.getElementById('longitude').value = pluginSettings.longitude;
            latitude = pluginSettings.latitude;
            longitude = pluginSettings.longitude;
            updateZoom();

            document.getElementById('units').value = pluginSettings.units;

            document.getElementById('displayRefreshTime').checked = pluginSettings.displayRefreshTime;
            document.getElementById('displayRefreshTime').value = pluginSettings.displayRefreshTime;

            document.getElementById('displayMetrics').checked = pluginSettings.displayMetrics;
            document.getElementById('displayMetrics').value = pluginSettings.displayMetrics;

            document.getElementById('displayGraph').checked = pluginSettings.displayGraph;
            document.getElementById('displayGraph').value = pluginSettings.displayGraph;

			document.getElementById('displayRain').checked = pluginSettings.displayRain;
            document.getElementById('displayRain').value = pluginSettings.displayRain;
			
            document.getElementById('displayForecast').checked = pluginSettings.displayForecast;
            document.getElementById('displayForecast').value = pluginSettings.displayForecast;

            document.getElementById('forecastDays').value = pluginSettings.forecastDays;

            document.getElementById('moonPhase').checked = pluginSettings.moonPhase;
            document.getElementById('moonPhase').value = pluginSettings.moonPhase;

            document.getElementById('weatherTimeZone').value = pluginSettings.weatherTimeZone;
            
            selectedTitle = pluginSettings.titleSelection || 'location';
            weatherProvider = pluginSettings.weatherProvider || 'OpenWeatherMap';

            document.getElementById('customTitle').value = pluginSettings.customTitle || '';
        } else {
            // set default values
            document.getElementById('units').value = "imperial";
            document.getElementById('displayRefreshTime').checked = true;
            document.getElementById('displayRefreshTime').value = "true";
            document.getElementById('displayMetrics').checked = true;
            document.getElementById('displayMetrics').value = "true";
            document.getElementById('displayGraph').checked = true;
            document.getElementById('displayGraph').value = "true";
			document.getElementById('displayRain').checked = false;
            document.getElementById('displayRain').value = "false";
            document.getElementById('displayForecast').checked = true;
            document.getElementById('displayForecast').value = "true";
            document.getElementById('forecastDays').value = 7;
            document.getElementById('moonPhase').checked = false;
            document.getElementById('weatherTimeZone').value = "locationTimeZone";

            // Auto-populate from device settings location if available and empty (or saved weather has no coords)
            try {
                const deviceCfg = {{ config | tojson }};
                const devLoc = deviceCfg && deviceCfg.device_location;
                const savedLat = pluginSettings && pluginSettings.latitude;
                const savedLon = pluginSettings && pluginSettings.longitude;
                if ((!(savedLat) || !(savedLon)) && (!latitude || !longitude) && devLoc && typeof devLoc.lat === 'number' && typeof devLoc.lon === 'number'){
                    latitude = devLoc.lat;
                    longitude = devLoc.lon;
                    $latitude.value = String(latitude);
                    $longitude.value = String(longitude);
                    updateZoom();
                }
            } catch(e) { /* ignore */ }
        }

        document.getElementById('weatherProvider').value = weatherProvider;
        document.querySelector(`input[name="titleSelection"][value="${selectedTitle}"]`).checked = true;
        updateTitleOptions(weatherProvider)

        // Helper to apply coordinates to inputs and map state
        function applyLatLon(lat, lon){
            try{
                latitude = Number(lat);
                longitude = Number(lon);
                $latitude.value = String(latitude);
                $longitude.value = String(longitude);
                updateZoom();
            } catch(e){}
        }

        async function sendClientLog(level, message, extra){
            try{
                await fetch('{{ url_for('settings.client_log') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ level, message, extra }) });
            } catch(_){}
        }

        async function fallbackApproxLocation(){
            try{
                // IP-based approximate location fallback (no prompt; less precise)
                let lat = null, lon = null;
                try {
                    const r = await fetch('https://ipapi.co/json', { cache: 'no-store' });
                    const j = await r.json();
                    if (j && typeof j.latitude === 'number' && typeof j.longitude === 'number'){
                        lat = j.latitude; lon = j.longitude;
                    }
                } catch(_) {}
                if (lat === null || lon === null){
                    const r2 = await fetch('https://ip-api.com/json', { cache: 'no-store' });
                    const j2 = await r2.json();
                    if (j2 && typeof j2.lat === 'number' && typeof j2.lon === 'number'){
                        lat = j2.lat; lon = j2.lon;
                    }
                }
                if (lat !== null && lon !== null){
                    applyLatLon(lat, lon);
                    sendClientLog('info', 'weather: used approximate IP location', { lat, lon });
                    if (window.showResponseModal){ showResponseModal('success', 'Used approximate location (IP).'); }
                } else {
                    sendClientLog('warn', 'weather: IP location unavailable');
                    if (window.showResponseModal){ showResponseModal('failure', 'Unable to determine location automatically. Use Select Location.'); }
                }
            } catch(e){
                sendClientLog('error', 'weather: IP location error', { error: String(e && e.message || e) });
                if (window.showResponseModal){ showResponseModal('failure', 'Unable to determine location automatically. Use Select Location.'); }
            }
        }

        // Use browser geolocation button
        const $useBrowser = document.getElementById('useBrowserLocation');
        if ($useBrowser){
            $useBrowser.addEventListener('click', () => {
                try{
                    if (!navigator.geolocation || !window.isSecureContext){
                        sendClientLog('warn', 'weather: precise geolocation unavailable (insecure context)');
                        if (window.showResponseModal){ showResponseModal('failure', 'Browser blocked precise location (requires HTTPS or localhost). Using approximate IP location…'); }
                        fallbackApproxLocation();
                        return;
                    }
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const { latitude: plat, longitude: plon, accuracy } = pos.coords || {};
                        applyLatLon(plat, plon);
                        sendClientLog('info', 'weather: precise location success', { lat: plat, lon: plon, accuracy });
                    }, (err) => {
                        sendClientLog('warn', 'weather: precise location denied/failure', { code: err && err.code, message: err && err.message });
                        if (window.showResponseModal){
                            const msg = (err && err.code === 1) ? 'Location permission denied. Using approximate IP location…' : 'Unable to get precise location. Using approximate IP location…';
                            showResponseModal('failure', msg);
                        }
                        fallbackApproxLocation();
                    }, { enableHighAccuracy: true, maximumAge: 60000, timeout: 5000 });
                } catch(e){ fallbackApproxLocation(); }
            });
        }
    });

    // Client-side validation specific to Weather plugin
    // Ensures latitude and longitude are present before Update Now or Add to Playlist
    window.validatePluginSettings = function(action){
        try {
            // Emit a small client log so we can verify saves contain the values
            try {
                const latDbg = document.getElementById('latitude')?.value;
                const lonDbg = document.getElementById('longitude')?.value;
                fetch('{{ url_for('settings.client_log') }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ level: 'debug', message: 'weather: submitting settings', extra: { action, lat: latDbg, lon: lonDbg } }) });
            } catch(e) {}
            const provider = (document.getElementById('weatherProvider') || {}).value || 'OpenWeatherMap';
            // Only enforce for providers that need coordinates (both do)
            const latEl = document.getElementById('latitude');
            const lonEl = document.getElementById('longitude');
            const lat = latEl && latEl.value ? String(latEl.value).trim() : '';
            const lon = lonEl && lonEl.value ? String(lonEl.value).trim() : '';

            const hasLat = lat !== '' && !isNaN(Number(lat));
            const hasLon = lon !== '' && !isNaN(Number(lon));

            if (!hasLat || !hasLon){
                const message = 'Please select a location first (Latitude and Longitude are required).';
                if (typeof window.showResponseModal === 'function'){
                    window.showResponseModal('failure', message);
                } else {
                    alert(message);
                }
                // Focus the Select Location button to guide the user
                const openMapBtn = document.getElementById('openMap');
                if (openMapBtn){ openMapBtn.focus(); }
                return false;
            }

            // Optional: basic range validation
            const latNum = Number(lat);
            const lonNum = Number(lon);
            if (latNum < -90 || latNum > 90 || lonNum < -180 || lonNum > 180){
                const message = 'Latitude must be between -90 and 90, Longitude between -180 and 180.';
                if (typeof window.showResponseModal === 'function'){
                    window.showResponseModal('failure', message);
                } else {
                    alert(message);
                }
                return false;
            }

            return true;
        } catch (e) {
            console.warn('Validation error:', e);
            return true; // do not block if validator fails unexpectedly
        }
    }
</script>
